<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retool Component API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .code {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .log {
            background-color: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Retool Component API Test Suite</h1>
        <p>This page tests the new RetoolComponentAPI with the GridComponentTest component.</p>
        
        <div class="test-section info">
            <h3>üìã Setup Instructions</h3>
            <ol>
                <li>Deploy your Retool component with GridComponentTest</li>
                <li>Open this HTML file in the same browser</li>
                <li>Open browser DevTools (F12) to see detailed logs</li>
                <li>Run the tests below</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üîß API Status</h3>
            <div id="apiStatus" class="status">Initializing...</div>
            <div id="componentStatus" class="status">Checking component...</div>
        </div>

        <div class="test-section">
            <h3>üéØ Quick Tests</h3>
            <button class="button" onclick="testSetValue()">Test setValue</button>
            <button class="button" onclick="testGetValue()">Test getValue</button>
            <button class="button" onclick="testPing()">Test Ping</button>
            <button class="button" onclick="testCustomCommand()">Test Custom Command</button>
            <button class="button" onclick="runAllTests()">Run All Tests</button>
            <button class="button" onclick="clearLog()">Clear Log</button>
        </div>

        <div class="test-section">
            <h3>üìù Manual Test Commands</h3>
            <div>
                <input type="text" id="manualValue" placeholder="Enter test value" value="Manual Test Value">
                <button class="button" onclick="manualSetValue()">Manual setValue</button>
            </div>
            <div style="margin-top: 10px;">
                <input type="text" id="customAction" placeholder="Custom action" value="ping">
                <input type="text" id="customPayload" placeholder="Custom payload (JSON)" value="{}">
                <button class="button" onclick="manualCustomCommand()">Send Custom Command</button>
            </div>
        </div>

        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h3>üñ•Ô∏è Console Log</h3>
            <div id="consoleLog" class="log"></div>
        </div>

        <div class="test-section">
            <h3>üìñ Usage Examples</h3>
            <div class="code">// Using the convenience functions
await setRetoolComponentValue('GridComponentTest', 'Hello World');
const value = await getRetoolComponentValue('GridComponentTest');

// Using the API class directly
const api = new RetoolComponentAPI();
await api.setValue('GridComponentTest', 'Hello World');
const value = await api.getValue('GridComponentTest');

// Custom commands
await api.customCommand('GridComponentTest', 'ping', {});
const status = await api.getStatus('GridComponentTest');</div>
        </div>
    </div>

    <!-- Include our API -->
    <script src="retool-component-api.js"></script>
    
    <script>
        // Test state
        let testResults = [];
        let api;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Initializing Retool Component API Test Suite');
            
            try {
                api = new RetoolComponentAPI();
                updateStatus('apiStatus', 'API Initialized ‚úÖ', 'success');
                log('‚úÖ RetoolComponentAPI instance created successfully');
                
                // Check for component
                checkComponentAvailability();
            } catch (error) {
                updateStatus('apiStatus', 'API Failed ‚ùå', 'error');
                log('‚ùå Failed to initialize API: ' + error.message);
            }
        });

        function updateStatus(elementId, text, className) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = 'status ' + className;
        }

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('consoleLog');
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[API Test] ${message}`);
        }

        function addTestResult(testName, success, message, data = null) {
            testResults.push({
                name: testName,
                success: success,
                message: message,
                data: data,
                timestamp: new Date().toLocaleTimeString()
            });
            updateTestResultsDisplay();
        }

        function updateTestResultsDisplay() {
            const resultsElement = document.getElementById('testResults');
            resultsElement.innerHTML = testResults.map(result => `
                <div class="test-section ${result.success ? 'success' : 'error'}">
                    <strong>${result.success ? '‚úÖ' : '‚ùå'} ${result.name}</strong> (${result.timestamp})<br>
                    ${result.message}
                    ${result.data ? `<br><code>${JSON.stringify(result.data, null, 2)}</code>` : ''}
                </div>
            `).join('');
        }

        async function checkComponentAvailability() {
            try {
                log('üîç Checking component availability...');
                const isAvailable = await api.ping('GridComponentTest');
                if (isAvailable) {
                    updateStatus('componentStatus', 'Component Available ‚úÖ', 'success');
                    log('‚úÖ GridComponentTest component is responding');
                } else {
                    updateStatus('componentStatus', 'Component Not Found ‚ùå', 'error');
                    log('‚ùå GridComponentTest component is not responding');
                }
            } catch (error) {
                updateStatus('componentStatus', 'Component Error ‚ùå', 'error');
                log('‚ùå Error checking component: ' + error.message);
            }
        }

        async function testSetValue() {
            try {
                log('üß™ Testing setValue...');
                const testValue = 'Test Value ' + new Date().toLocaleTimeString();
                const result = await api.setValue('GridComponentTest', testValue);
                log('‚úÖ setValue successful');
                addTestResult('setValue', true, `Successfully set value to: ${testValue}`, result);
            } catch (error) {
                log('‚ùå setValue failed: ' + error.message);
                addTestResult('setValue', false, error.message);
            }
        }

        async function testGetValue() {
            try {
                log('üß™ Testing getValue...');
                const value = await api.getValue('GridComponentTest');
                log('‚úÖ getValue successful: ' + value);
                addTestResult('getValue', true, `Retrieved value: ${value}`, { value });
            } catch (error) {
                log('‚ùå getValue failed: ' + error.message);
                addTestResult('getValue', false, error.message);
            }
        }

        async function testPing() {
            try {
                log('üß™ Testing ping...');
                const isAvailable = await api.ping('GridComponentTest');
                log('‚úÖ Ping successful: ' + isAvailable);
                addTestResult('ping', true, `Component available: ${isAvailable}`, { available: isAvailable });
            } catch (error) {
                log('‚ùå Ping failed: ' + error.message);
                addTestResult('ping', false, error.message);
            }
        }

        async function testCustomCommand() {
            try {
                log('üß™ Testing custom command...');
                const result = await api.customCommand('GridComponentTest', 'ping', {});
                log('‚úÖ Custom command successful');
                addTestResult('customCommand', true, 'Custom ping command successful', result);
            } catch (error) {
                log('‚ùå Custom command failed: ' + error.message);
                addTestResult('customCommand', false, error.message);
            }
        }

        async function manualSetValue() {
            const value = document.getElementById('manualValue').value;
            try {
                log(`üß™ Manual setValue: ${value}`);
                const result = await api.setValue('GridComponentTest', value);
                log('‚úÖ Manual setValue successful');
                addTestResult('manualSetValue', true, `Manually set value to: ${value}`, result);
            } catch (error) {
                log('‚ùå Manual setValue failed: ' + error.message);
                addTestResult('manualSetValue', false, error.message);
            }
        }

        async function manualCustomCommand() {
            const action = document.getElementById('customAction').value;
            const payloadStr = document.getElementById('customPayload').value;
            
            try {
                const payload = JSON.parse(payloadStr);
                log(`üß™ Manual custom command: ${action}`);
                const result = await api.customCommand('GridComponentTest', action, payload);
                log('‚úÖ Manual custom command successful');
                addTestResult('manualCustomCommand', true, `Custom command ${action} successful`, result);
            } catch (error) {
                log('‚ùå Manual custom command failed: ' + error.message);
                addTestResult('manualCustomCommand', false, error.message);
            }
        }

        async function runAllTests() {
            log('üöÄ Running all tests...');
            testResults = []; // Clear previous results
            
            await testPing();
            await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
            
            await testSetValue();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testGetValue();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testCustomCommand();
            
            log('üèÅ All tests completed');
        }

        function clearLog() {
            document.getElementById('consoleLog').innerHTML = '';
            log('üìù Log cleared');
        }

        // Global convenience functions for manual testing in browser console
        window.testAPI = {
            setValue: (value) => api.setValue('GridComponentTest', value),
            getValue: () => api.getValue('GridComponentTest'),
            ping: () => api.ping('GridComponentTest'),
            custom: (action, payload) => api.customCommand('GridComponentTest', action, payload),
            api: api
        };

        // Listen for component responses to log them
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'RETOOL_COMPONENT_RESPONSE') {
                log(`üì® Component Response: ${JSON.stringify(event.data)}`);
            }
        });
    </script>
</body>
</html>
